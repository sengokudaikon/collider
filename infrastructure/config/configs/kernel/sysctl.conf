# Collider System Tuning - Environment-Aware Configuration
# Apply with: sudo sysctl -p /path/to/this/file
#
# This consolidated configuration optimizes for high-performance event processing
# while maintaining security and system stability across different environments.

# ========================================
# NETWORK PERFORMANCE OPTIMIZATIONS
# ========================================

# Core network settings
net.core.somaxconn = 65535                    # Maximum socket connections
net.core.netdev_max_backlog = 65535           # Network device backlog
net.core.netdev_budget = 600                  # Network processing budget  
net.core.netdev_budget_usecs = 5000           # Network processing time limit

# TCP connection limits and timeouts
net.ipv4.tcp_max_syn_backlog = 65535          # SYN flood protection
net.ipv4.ip_local_port_range = 1024 65535     # Available ports range
net.ipv4.tcp_tw_reuse = 1                     # Reuse TIME_WAIT sockets
net.ipv4.tcp_fin_timeout = 15                 # Fast connection cleanup

# Buffer sizes for high throughput
net.core.rmem_max = 134217728                 # Max receive buffer (128MB)
net.core.wmem_max = 134217728                 # Max send buffer (128MB)
net.core.rmem_default = 262144                # Default receive buffer
net.core.wmem_default = 262144                # Default send buffer
net.ipv4.tcp_rmem = 4096 262144 134217728     # TCP receive buffer scaling
net.ipv4.tcp_wmem = 4096 262144 134217728     # TCP send buffer scaling

# TCP performance tuning
net.ipv4.tcp_congestion_control = bbr         # BBR congestion control for high throughput
net.core.default_qdisc = fq                   # Fair queuing discipline
net.ipv4.tcp_slow_start_after_idle = 0        # Disable slow start after idle
net.ipv4.tcp_no_metrics_save = 1              # Don't cache connection metrics
net.ipv4.tcp_mtu_probing = 1                  # Enable MTU probing
net.ipv4.tcp_window_scaling = 1               # Enable window scaling
net.ipv4.tcp_timestamps = 1                   # Enable timestamps
net.ipv4.tcp_sack = 1                         # Enable selective ACK

# TCP keepalive settings
net.ipv4.tcp_keepalive_time = 600             # Keepalive probe interval (optimized for load)
net.ipv4.tcp_keepalive_probes = 3             # Number of keepalive probes
net.ipv4.tcp_keepalive_intvl = 15             # Interval between probes

# Connection tracking (for high load environments)
net.netfilter.nf_conntrack_max = 524288
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30

# ========================================
# SECURITY SETTINGS
# ========================================

net.ipv4.tcp_syncookies = 1                   # SYN flood protection
net.ipv4.conf.default.rp_filter = 1           # Reverse path filtering
net.ipv4.conf.all.rp_filter = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1      # Ignore ICMP broadcasts
net.ipv4.icmp_ignore_bogus_error_responses = 1 # Ignore bogus ICMP errors

# ========================================
# MEMORY MANAGEMENT
# ========================================

# Virtual memory tuning for high-throughput applications
vm.swappiness = 10                             # Avoid swap usage (balanced approach)
vm.dirty_ratio = 15                           # Dirty page threshold
vm.dirty_background_ratio = 5                 # Background dirty page threshold
vm.overcommit_memory = 1                      # Allow memory overcommit
vm.max_map_count = 262144                     # Max memory maps

# ========================================
# FILE SYSTEM LIMITS
# ========================================

# File handle limits for high concurrency
fs.file-max = 2097152                         # System-wide file handles
fs.nr_open = 2097152                          # Per-process file handles

# ========================================
# KERNEL PERFORMANCE
# ========================================

# Process scheduling optimizations
kernel.sched_autogroup_enabled = 0            # Disable automatic process grouping
kernel.sched_migration_cost_ns = 5000000      # CPU migration cost
kernel.pid_max = 4194304                      # Maximum process IDs

# ========================================
# ENVIRONMENT-SPECIFIC TUNING
# ========================================

# For production environments with high load:
# - BBR congestion control is enabled by default
# - Large buffer sizes for sustained throughput
# - Optimized for small HTTP requests and database connections

# For development environments:
# - Settings are conservative but still performant
# - Security settings maintained

# For GCP Cloud Run environments:
# - Optimized for containerized workloads
# - Memory settings appropriate for managed services

# ========================================
# OPTIONAL SETTINGS
# ========================================

# Huge pages for database performance (uncomment if using large shared memory)
# vm.nr_hugepages = 1024

# I/O scheduling for SSDs (set per-device)
# echo noop > /sys/block/sda/queue/scheduler